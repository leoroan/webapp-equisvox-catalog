<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Proyecto | Ofertas</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@500;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-main: #0b1220;
            --bg-soft: #1e1b4b;
            --bg-card: #111827;
            --txt-main: #e5e7eb;
            --txt-muted: #94a3b8;
            --accent: #60a5fa;
            --success: #22c55e;
        }

        body {
            background: linear-gradient(135deg, var(--bg-main), var(--bg-soft));
            font-family: Inter, sans-serif;
            color: var(--txt-main);
            min-height: 100vh;
        }

        h1 {
            font-family: Poppins, sans-serif;
        }

        /* Layout */
        .layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 1rem;
        }

        @media (max-width: 992px) {
            .layout {
                grid-template-columns: 1fr;
            }
        }

        /* Filters */
        .filters {
            background: rgba(17, 24, 39, 0.9);
            border-radius: .75rem;
            padding: 1rem;
            font-size: .85rem;
        }

        .filters label {
            font-size: .7rem;
            color: var(--txt-muted);
        }

        /* Table */
        .table-wrap {
            background: rgba(17, 24, 39, 0.9);
            border-radius: .75rem;
            overflow: hidden;
        }

        table {
            color: var(--txt-main);
            margin: 0;
            font-size: .85rem;
        }

        thead {
            background: #020617;
        }

        th {
            font-weight: 500;
            color: var(--txt-muted);
        }

        tbody tr:hover {
            background: rgba(96, 165, 250, 0.08);
        }

        .game-img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: .25rem;
            background: #020617;
        }

        .old-price {
            text-decoration: line-through;
            color: var(--txt-muted);
            font-size: .75rem;
        }

        .discount {
            color: var(--success);
            font-weight: 600;
        }

        /* Pagination */
        .pagination {
            margin: 0;
        }

        .page-link {
            background: transparent;
            color: var(--txt-main);
            border: none;
        }

        .page-item.active .page-link {
            background: var(--accent);
            color: #020617;
            border-radius: .25rem;
        }

        .game-icon {
            width: 40px;
            height: 40px;
            border-radius: .5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b, #020617);
            color: #60a5fa;
            cursor: pointer;
        }

        .game-icon:hover {
            background: linear-gradient(135deg, #1e40af, #020617);
        }
    </style>
</head>

<body>

    <main class="container-fluid py-4">
        <h1 class="mb-4">Ofertas</h1>

        <section class="layout">
            <!-- Filters -->
            <aside class="filters">
                <h6 class="mb-3">Filtros</h6>

                <div class="mb-2">
                    <label>Título</label>
                    <input id="fTitle" class="form-control form-control-sm" placeholder="Buscar…">
                </div>

                <div class="mb-2">
                    <label>Oferta contiene</label>
                    <input id="fOffer" class="form-control form-control-sm" placeholder="Texto de oferta">
                </div>

                <div class="mb-2">
                    <label>Precio máximo</label>
                    <input id="fMaxPrice" type="number" class="form-control form-control-sm" placeholder="$">
                </div>

                <div class="mb-2">
                    <label>Descuento mínimo (%)</label>
                    <select id="fDiscount" class="form-select form-select-sm">
                        <option value="0">Cualquiera</option>
                        <option value="25">25%+</option>
                        <option value="50">50%+</option>
                        <option value="75">75%+</option>
                    </select>
                </div>
            </aside>

            <!-- Table -->
            <section class="table-wrap">
                <table class="table table-dark table-sm align-middle">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Título</th>
                            <th>Precio</th>
                            <th>Descuento</th>
                            <th>Oferta</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="rows"></tbody>
                </table>

                <nav class="d-flex justify-content-end p-2">
                    <ul id="pagination" class="pagination pagination-sm"></ul>
                </nav>
            </section>
        </section>
    </main>

    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="detailImage" class="img-fluid rounded mb-3" alt="">
                    <p id="detailOffer" class="text-muted"></p>
                    <p>
                        <span class="old-price" id="detailOriginal"></span><br>
                        <strong id="detailCurrent"></strong>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // SVG placeholder base64 (40x40)
        const PLACEHOLDER_IMG = 'data:image/svg+xml;base64,' + btoa(`<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40">
  <rect width="40" height="40" rx="4" fill="#020617"/>
  <path d="M8 26l6-7 5 6 4-5 9 10H8z" fill="#334155"/>
  <circle cx="26" cy="14" r="3" fill="#475569"/>
</svg>`);

        class CsvDataSource {
            constructor(url) { this.url = url; }

            async fetch() {
                const res = await fetch(this.url);
                const text = await res.text();
                const [h, ...r] = text.trim().split('\n');
                const headers = h.split(',').map(x => x.trim());

                return r.map(row => {
                    const v = row.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/)
                        .map(x => x.replace(/"/g, '').trim());
                    const o = Object.fromEntries(
                        headers.map((key, i) => [key, v[i]])
                    );
                    return {
                        id: o.ID?.trim(),
                        title: o.Title?.trim(),
                        original: Number(o['Original Price']),
                        current: Number(o['Current Price']),
                        discount: parseFloat(o['Discount %']) || 0,
                        offer: o.Offer?.trim(),
                        url: o.URL?.trim(),
                        imageUrl: o['Image URL']?.trim() || ''
                    };
                }).sort((a, b) => a.title.localeCompare(b.title));
            }
        }

        const state = {
            data: [],
            filtered: [],
            page: 1,
            perPage: 10
        };

        function applyFilters() {
            const title = fTitle.value.toLowerCase();
            const offer = fOffer.value.toLowerCase();
            const max = Number(fMaxPrice.value || Infinity);
            const minDisc = Number(fDiscount.value);

            state.filtered = state.data.filter(i =>
                i.title.toLowerCase().includes(title) &&
                i.offer.toLowerCase().includes(offer) &&
                i.current <= max &&
                i.discount >= minDisc
            );

            state.page = 1;
            render();
        }

        function render() {
            renderRows();
            renderPagination();
        }

        function renderRows() {
            rows.innerHTML = '';

            const start = (state.page - 1) * state.perPage;
            const page = state.filtered.slice(start, start + state.perPage);

            page.forEach((i, idx) => {
                rows.innerHTML += `
      <tr>
        <td>
          <div class="game-icon" onclick="openDetail(${start + idx})">
            <i class="bi bi-controller fs-5"></i>
          </div>
        </td>
        <td>${i.title}</td>
        <td>
          <span class="old-price">$${i.original}</span><br>
          $${i.current}
        </td>
        <td class="discount">-${i.discount}%</td>
        <td>${i.offer}</td>
        <td>
          <a href="${i.url}" target="_blank" class="btn btn-sm btn-outline-info">
            Ver
          </a>
        </td>
      </tr>
    `;
            });
        }



        function renderPagination() {
            const pages = Math.ceil(state.filtered.length / state.perPage);
            pagination.innerHTML = '';

            for (let i = 1; i <= pages; i++) {
                pagination.innerHTML += `
        <li class="page-item ${i === state.page ? 'active' : ''}">
          <button class="page-link" onclick="state.page=${i};render()">${i}</button>
        </li>`;
            }
        }

        async function init() {
            const ds = new CsvDataSource('./sample_data.csv');
            state.data = await ds.fetch();
            state.filtered = [...state.data];

            [fTitle, fOffer, fMaxPrice, fDiscount].forEach(el =>
                el.addEventListener('input', applyFilters)
            );

            render();
        }

        init();


        const modal = new bootstrap.Modal(
            document.getElementById('detailModal')
        );

        function openDetail(index) {
            const i = state.filtered[index];

            detailTitle.textContent = i.title;
            detailOffer.textContent = i.offer;
            detailOriginal.textContent = `$${i.original}`;
            detailCurrent.textContent = `$${i.current}`;
            detailImage.src = i.imageUrl || PLACEHOLDER_IMG;
            detailImage.alt = `Portada de ${i.title}`;

            modal.show();
        }

    </script>

</body>

</html>